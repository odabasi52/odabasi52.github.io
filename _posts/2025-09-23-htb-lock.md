---
layout: post
title: "Lock - Hack The Box"
summary: "Gitea repository enumeration → API token discovery in commit history → private website repository access via Gitea API → git clone with token authentication → production deployment via direct git push (reverse shell PHP) → mRemoteNG config.xml discovery → password decryption via mRemoteNG_password_decrypt tool → RDP access → PDF24 Creator CVE-2023-49147 MSI exploitation → SetOpLock.exe symbolic link attack → SYSTEM shell via legacy console mode browser"
---

# Lock - Hack The Box

## Enumeration
### Nmap 
Initial Nmap scan revealed HTTP, RDP, SMB and Port 3000 were open.

<img width="1120" height="761" alt="00 - nmap" src="https://github.com/user-attachments/assets/1b8c320b-cf26-48db-b178-465198256cf3" />

### Web Enumeration
Website was a static website. There were 3 usernames, I noted them. Then applied directory brute forcing but nothing revealed.

<img width="1782" height="717" alt="01 - website" src="https://github.com/user-attachments/assets/c7668661-ae81-42ee-a34e-69fce92ef400" />

Then visited the port 3000 which was a gitea server. The version was not vulnerable to anything. At first I checked the users and noted them.

<img width="1920" height="552" alt="02 - gitea users" src="https://github.com/user-attachments/assets/b4043dad-b2fb-4f59-abd2-b4880cbc5832" />

## Exploitation
While searching the ellen.freeman's repositories, I found a repo that includes a python script which gets all repositories using API. There were 2 commits. I checked the first commit and found an Authorization token.

<img width="1920" height="941" alt="03 - api key" src="https://github.com/user-attachments/assets/89fe2011-2676-4bf4-b34e-e6f31b208cc6" />

Then downloaded the script and tried to enumerate repositories myself. There was another private repository named website.

<img width="681" height="186" alt="04 - updated script" src="https://github.com/user-attachments/assets/a52e056b-6399-4df6-8e74-844378b4798d" />

Then at first I searched for Gitea API Documentation and found a comprehensive [documentation](https://docs.gitea.com/api/). Then I opened the burp suite and using tis documentation I found the git clone link of the website repository.

<img width="1199" height="370" alt="05 - git url" src="https://github.com/user-attachments/assets/4f4473e6-9615-485e-9b1d-45df2ca47e07" />

Then cloned it using the token and the username.

<img width="727" height="323" alt="06 - cloned it" src="https://github.com/user-attachments/assets/120867c4-b7f6-4d4e-9426-011f500ebf6f" />

The repository was HTTP website's repository. I tested to push some dummy file "mytest.txt" and visited the HTTP website. It showed my file. So it was directly pushing to the production. With this knowledge, I knew that I could directly push a reverse shell.

<img width="765" height="565" alt="07 - git push" src="https://github.com/user-attachments/assets/3c0da659-6232-4b0c-b435-9406135fec8e" />

Then visiting the reverse shell page while listening with netcat got me the reverse shell.

<img width="680" height="216" alt="08 - revshell" src="https://github.com/user-attachments/assets/f14758a6-3b3a-41fc-8e3f-78aa91650f0c" />

Then while searching through ellen.freeman's directories I found a config.xml file which included an encrypted RDP password.

<img width="1748" height="655" alt="09 - config" src="https://github.com/user-attachments/assets/6a8b1965-7490-4110-8d7e-5584087ff943" />

Searching through the internet, I found [Decrypt mRemoteNG configuration files](https://www.errno.fr/mRemoteNG.html) post which explains how to decrypt that password. The post was forwarding us to [mRemoteNG_password_decrypt](https://github.com/gquere/mRemoteNG_password_decrypt) repository. I used this tool and got the username and password.

<img width="707" height="148" alt="10 - decrypted" src="https://github.com/user-attachments/assets/11cd985b-9722-4265-9fc2-ee33acc1c06f" />

Then simply logged in using RDP.

<img width="1602" height="105" alt="11 - rdp command" src="https://github.com/user-attachments/assets/b8accd8b-b15c-478e-a814-243b5c1b6a80" />

And got the user flag.

<img width="1601" height="788" alt="12 - user flag ez" src="https://github.com/user-attachments/assets/8481f40e-05a8-40ca-a47b-8a08e0af3f1b" />

## Privilege Escalation
On the desktop there was an uncommon executable named PDF24. At first I opened it and checked the version.

<img width="839" height="429" alt="13 - version of pdf" src="https://github.com/user-attachments/assets/bed28962-35a5-4d64-9802-d2df58107385" />

Then searching the version I found out it was vulnerable to CVE-2023-49147. I found [this post](https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-msi-installer-in-pdf24-creator-geek-software-gmbh/) which explains PoC in detail.

### Step by Step CVE-2023-49147
So first step was to find an msi installer for pdf24. I used search bar and found the location for installer file. Then the post said run SetOpLock.exe file before starting installation. So I download it from the [symboliclink-testing-tools](https://github.com/googleprojectzero/symboliclink-testing-tools/releases/tag/v1.0) and started listener. Then I ran the msi installer while listening which got me an empty shell.

<img width="1575" height="790" alt="14 - oplock triggered" src="https://github.com/user-attachments/assets/58ff609a-ce25-4d1c-adc6-48a8cab993b2" />

Then the post mentions these steps:
- right click on the top bar of the cmd window
- click on properties
- under options click on the "Legacyconsolemode" link
- open the link with a browser other than internet explorer or edge (both don't open as SYSTEM when on Win11)
- in the opened browser window press the key combination CTRL+o
- type cmd.exe in the top bar and press Enter

So I right clicked, then clicked the legacy console mode link and used the key combination CTRL + O to download cmd.exe

<img width="1271" height="703" alt="15 - cmd exe" src="https://github.com/user-attachments/assets/93723edc-d696-4e1a-8df5-7ef8532ce423" />

After downloading, I opened it and it was a SYSTEM shell. I simply got the root flag.

<img width="365" height="91" alt="16 - gg" src="https://github.com/user-attachments/assets/2e73e65b-0b11-437d-9196-7fb6c73cc3bc" />

## Pwned
The machine was fully compromised.

<img width="742" height="688" alt="pwned" src="https://github.com/user-attachments/assets/665d4260-7506-4189-88d8-1edacc9f81f9" />

