# Media - Hack The Box

## Enumeration
Initial nmap scan revealed SSH, HTTP and RDP ports were open.

<img width="1101" height="413" alt="00 - nmap" src="https://github.com/user-attachments/assets/9cdbe29f-7210-4c18-827e-3d4084b55d0f" />

## Exploitation
At first I found 3 names on the website. So I created a userList with username-anarchy and applied some basic brute forcing but none of them worked.

<img width="1823" height="762" alt="02 - UserList" src="https://github.com/user-attachments/assets/b4503a9f-6ffe-4928-b01c-6a909ca4e716" />

There was also an upload function on the website which states upload files that are compatible with windows media player. At first I uploaded random files and did directory brute force to find uploaded files but could not find anything useful.

Then I searched windows media player pentesting got [this](https://medium.com/@whickey000/creating-malicious-wms-files-malware-mondays-3-d4dbcb06a54f) post. We can apply NTLM Authentication attack with windows media player. [This](https://www.morphisec.com/blog/5-ntlm-vulnerabilities-unpatched-privilege-escalation-threats-in-microsoft/) post is also great and explains NTLM Authentication against microsoft related tools.

So at first, I created a .wmx file. It can also be created using [ntlm_theft repo](https://github.com/Greenwolf/ntlm_theft) (.asx file).

<img width="673" height="171" alt="04 - wmx file" src="https://github.com/user-attachments/assets/f2d6a31d-bf56-4b57-96d6-61f71679eda8" />

Then waited while responder was running and got the NTLM hash.

<img width="1478" height="151" alt="05 - hash" src="https://github.com/user-attachments/assets/4765ad1d-564a-4e46-9fd1-b37a4109aed9" />

Cracked the hash using hashcat.

<img width="1886" height="170" alt="06 - cracked" src="https://github.com/user-attachments/assets/1f9bbe27-ed1a-4e64-bffe-382ce2a4e2b5" />

Got the User Flag.

<img width="1147" height="449" alt="07 - user flag" src="https://github.com/user-attachments/assets/a030fa08-dab9-4deb-9fc3-85268db954aa" />

## Privilege Escalation
I ran PrivescCheck.ps1 and WinPEAS which did not reveal anything useful. Then checked the index.php under C:\xampp\htdocs. 

The file included uploading functionality. So it creates an md5 hash with firstname, lastname and email, then checks C:\Windows\Tasks\Uploads\<md5> if there is a folder it puts the file in it if not it creates the folder then puts the file in it.

<img width="1568" height="871" alt="08 - index php" src="https://github.com/user-attachments/assets/607b1997-0eb1-4b1d-9a86-35cd17da7b08" />

<img width="798" height="229" alt="09 - file uploaded" src="https://github.com/user-attachments/assets/ed5f1795-f533-44d9-8e5c-03544f866957" />

So I thought what if I create a symbolic link to C:\xampp\htdocs with the name of the md5 folder. So when the script checks it will find the folder and put the file inside it.

[This](https://www.howtogeek.com/16226/complete-guide-to-symbolic-links-symlinks-on-windows-or-linux/) post explains symbolic links in detail.

<img width="1229" height="720" alt="10 - linked" src="https://github.com/user-attachments/assets/a240eaae-9e10-4e0a-a48e-86d9ddbfee50" />

After creating the link, I could upload the web root.

<img width="1032" height="416" alt="11 - uploaded" src="https://github.com/user-attachments/assets/45e063b1-1019-45f4-8225-9353f2a76ce3" />

Then using [Invoke-PowerShellTcp.ps1](https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1), I got the reverse shell.

<img width="1884" height="853" alt="12 - get" src="https://github.com/user-attachments/assets/d3f92a02-9aa0-40ff-80f0-d7ae5815e014" />

<img width="692" height="197" alt="13 - revshell" src="https://github.com/user-attachments/assets/e03b9dc6-51ae-4c86-937c-1875e5d37f28" />

Current shell was NT Authority\Local Service but it did not have the SeImpersonatePrivilege. So I searched through the internet and found [FullPowers](https://github.com/itm4n/FullPowers) tool. The tool allows to get a shell with all service privileges if current user is local service. 

So using [Reverse Shell Generator](https://www.revshells.com/), I created a base64 encoded reverse shell and ran it using FullPowers.

<img width="1888" height="199" alt="14 - revshell within revshell" src="https://github.com/user-attachments/assets/7d3fb284-b25a-4cc5-9e4a-5d1f88680c6c" />

With the new reverse shell, I got SeImpersonatePrivilege.

<img width="1147" height="440" alt="15 - priv enabled" src="https://github.com/user-attachments/assets/de4d23ab-04ab-4912-8f0d-9b0541d78982" />

I then used [Sigma Patato](https://github.com/tylerdotrar/SigmaPotato) to get a SYSTEM shell, and got the root flag.

<img width="670" height="70" alt="16 - sigma patato" src="https://github.com/user-attachments/assets/1819e793-75d0-40ea-a433-30641c2e46e8" />

<img width="689" height="187" alt="17 - root txt" src="https://github.com/user-attachments/assets/21bdfded-58f1-4b90-9e2b-30ad5f89937d" />

## Pwned
The machine was fully compromised.

<img width="722" height="619" alt="18 - pwned" src="https://github.com/user-attachments/assets/7cea4bf7-96e6-4301-a532-d710594d163a" />
